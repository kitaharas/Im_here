<%= javascript_include_tag "main.js" %> 

<header>
  <section id="modal" class="hidden">
    <div class="container">
      <ul class="modal-ul">
        <li class="login-li">
          <div style="height:26px;">
            <p class="form-error" style="color:red; text-align:center;">
              emailもしくはpasswordに誤りがあります
            </p>
          </div>
          <div class="login_container">
            <input type="text" size="25" name="session[email]" id="user_email" placeholder="EMAIL">
            <input type="text" size="25" name="session[password]" id ="user_password" placeholder="PASSWORD" >
            <input type="submit" id="btn_submit" name="commit" value="log in!" data-disable-with="Create User">
          </div>
          <p class="signup-text">新規登録は<span onclick="SignUpPage()"><a>コチラ</a></span></p>
        </li>
        <li class="sign-up-li">
          <p>Sign Up!</p>
          <form class="login_container"  data-remote="true">
            <input type="text" size="25" placeholder="NAME" name="user[name]" id="user_new_name" >
            <input type="text" size="25" placeholder="EMAIL" name="user[email]" id="user_new_email">
            <input type="password" size="25" placeholder="PASSWORD" name="user[password]" id="user_new_password" autocomplete="off">
            <input type="password" size="25" placeholder="PASSWORD" name="user[password_confirmation]" id="user_new_passconfi" autocomplete="off">
            <input type="submit"  value="sign up!" id="signup-btn" data-disable-with="Signup User">
          </form>
        </li>
        <li id="signup-about">
          <div class="list-area">
            <h2><img src="/assets/logo.png"></h2>
            <p>は誰でも&nbsp;誰とでも繋がれるコミュニティツールです!</p>
          </div>
        </li>
        <li id="signup-about2">
          <div class="list-area2">
            <h2><img src="/assets/logo.png"></h2>
            <p>を使って、レッスンに参加したり、<br>
              自分の演奏を披露したりすることが出来ます。
            </p>
            <p>
              また、新たなコミュニティを通じて自身の可能性を<br>
              見出すこともできるかも知れません。
            </p>
            <p>
              チャットや音声で、ただ会話を楽しむ事も<br>
              それはあなたのライフスタイルの一部になってくれるでしょう。
            </p>
          </div>
        </li>
        <li id="signup-about3">
          <div class="list-area3">
            <h2><img src="/assets/logo.png"></h2>
            <p>を通じて、</p>
            <p>あなたの世界が少しでも広がる事を</p>
            <p>願っています。</p>
            <%= link_to root_path do %>
            <button class="btn-go" id="btn-go">Go!</button>
            <% end %>
          </div>
        </li>
      </ul>
    </div>
    <button id="prev" onclick="Prev()" class="hidden">←戻る</button>
    <button id="next" onclick="Next()" class="hidden">進む→</button>
    <div id="close">閉じる</div>
  </section>
  <div id="mask" class="hidden"></div>
  
  <div class="status_bar">
    <form method="get" action="#" class="search_container">
      <input type="text" size="25" placeholder="キーワード検索">
      <input type="submit"  value="&#xf002">
    </form>
    <div class="status_bar_right">
      <% if logged_in? %>
        <%= link_to image_tag("/assets/login.png"), "/users/#{current_user.id}" ,class:"acount-logo","data-turbolinks":false %>
      <% else %>
        <div class="acount-logo" onclick="LoginPage()" data-turbolinks="false" ><%= image_tag("/assets/login.png") %></div>
      <% end %>
      <% if logged_in? %>
        <span><%= link_to "Log out", logout_path, method: :delete ,class:"loginout" %></span>
      <% else %>
        <span onclick="LoginPage()" data-turbolinks="false"><a class="loginout">Log in</a></span>
      <% end %>
      <ul>
        <li><%= link_to image_tag("/assets/facebook.png"),'https://www.facebook.com/' %></li>
        <li><%= link_to image_tag("/assets/Messenger.png"),'https://www.facebook.com/messenger/' %></li>
        <li><%= link_to image_tag("/assets/insta.png"),'https://www.instagram.com/' %></li>
        <li><%= link_to image_tag("/assets/twitter.png"),'https://www.twitter.com/' %></li>
      </ul>
    </div>
  </div>
  <div class="global-menu">
    <h1 class="main-logo" data-turbolinks="false"><%= link_to image_tag("/assets/logo.png"), root_path %></h1>
    <div class="menu">
      <ul data-turbolinks="false">
        <li data-turbolinks="false"><%= link_to "about", about_path %></li>
        <li data-turbolinks="false"><%= link_to "ジャンル別", genre_path %></li>
        <li data-turbolinks="false"><%= link_to "気分別", feel_path %></li>
        <% if logged_in? %>
          <li class="hov-menu"><a>マイメニュー<span>▼</span></a>
            <ul>
              <li><%= link_to "マイページ" ,"/users/#{current_user.id}" %></li>
              <li><%= link_to "プロフィール編集" ,"/users/#{current_user.id}/edit" %></li>
              <li onclick="eventModal()"><a>イベント登録</a></li>
            </ul>
          </li>
        <% else %>
          <li id="signup-btn" onclick="SignUpPage()"><a id="signup">新規登録</a></li>
        <% end %>
      </ul>
    </div>
  </div>

  <div class="event-modal hidden">
    <h3>イベント情報入力</h3>
      <%= form_for :event, url: event_confirm_path ,class: "event_container" do |f| %>
        <div>
          <%= f.label :event_title, "タイトル" %>
          <%= f.text_field :event_title, :placeholder => "ギター弾く19時まで", id: :e_title %>
        </div>
        <div>
          <%= f.label :content, "メモ" %>
          <%= f.text_area :content, :placeholder => "これからなんとなくギター弾きます。暇人集まれー。", size: "30x5", id: :e_memo %>
        </div>
        <div>
          <%= f.label :genre_id ,'ジャンル'%>
          <%= f.select :genre_id, {'aaa':1,'bbb':2,'ccc':3,'ddd':4,'eee':5,'fff':6}, { include_blank: '選択してください'} %>
        </div>
        <div>
          <%= f.label :feel_id ,'気分'%>
          <%= f.select :feel_id, {'aaa':1,'bbb':2,'ccc':3,'ddd':4,'eee':5,'fff':6}, { include_blank: '選択してください'} %>
        </div>
        <div>
          <label>日時</label>
          <label><%= f.radio_button :date ,"今すぐ",id: :e_play ,checked: true %>今すぐ</label>
          <label><%= f.radio_button :date ,1,id: :e_date %>時間指定</label>
          <br>
          <%= f.label :created_at_date, '登録日', class: 'control-label' %>
          <%= f.date_field :created_at_date, class: 'form-control' , disabled: true %>

          <%= f.label :created_at_time, '登録時間', class: 'control-label' %>
          <%= f.time_field :created_at_time, class: 'form-control' , disabled: true %>
        </div>
        <div>
          <label>方法</label>
          <label><%= f.radio_button :line ,"オンライン",id: :online, checked: true %>オンライン</label>
          <label><%= f.radio_button :line ,1,id: :offline %>オフライン</label>
        </div>

        <div>
          <%= f.label :place ,"場所" %>
          <%= f.text_field :place, :placeholder => "江戸川区西葛西", id: :place , disabled: true %>
        </div>
        <div>
          <%= f.label :people,"人数" %>
          <%= f.text_field :people, id: :people %>
          <span>※空欄で制限なし</span>
        </div>
        <input type="submit" value="イベント登録" onclick="goEvent();return false;" id="event_confirm">
      <% end %>
        <%# <div>
        <label for="regularly">定期開催</label>
        <input id="regularly" type="checkbox">
      </div> %>
    </form>
    <div id="event-close" onclick="eventClose()">
      閉じる
    </div>
  </div>



  <section id="confi-modal" class="hidden" tabindex="-1" aria-labelledby="exampleModalLabel">
    <div class="confi-container">
      <p>以下の内容で登録します。<br>
        よろしいですか？
      </p>
    </div>
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-body">
        <div>
          <p class="text-muted">タイトル</p>
          <p class="px-2" id="modalTitle"></p>
        </div>
        <div>
          <p class="text-muted">本文</p>
          <p class="px-2" id="modalBody"></p>
        </div>
        <div>
          <p class="text-muted">ジャンル</p>
          <p class="px-2" id="modalGenre"></p>
        </div>
        <div>
          <p class="text-muted">気分</p>
          <p class="px-2" id="modalFeel"></p>
        </div>
        <div>
          <p class="text-muted">日にち</p>
          <p class="px-2" id="modalDate"></p>
          <p class="px-2" id="modalFullDate"></p>
          <p class="px-2" id="modalTime"></p>
        </div>
        <div>
          <p class="text-muted">場所</p>
          <p class="px-2" id="modalPlace"></p>
        </div>
        <div>
          <p class="text-muted">人数</p>
          <p class="px-2" id="modalPeople"></p>
        </div>
      </div>
    </div>
    <div id="confi-close" onclick="confiClose()">戻る</div>
  </section>
  <div id="confi-mask" class="hidden"></div>
</header>

<script>
  $(function(){
    $( 'input[name="event[date]"]:radio').change(function(){
      var radioval = $(this).val();
      if(radioval == 1){
        $('#event_created_at_date').removeAttr('disabled');
        $('#event_created_at_time').removeAttr('disabled');
      } else {
        $('#event_created_at_date').attr('disabled','disabled');
        $('#event_created_at_time').attr('disabled','disabled');
      }
    });
  });

  $(function(){
    $( 'input[name="event[line]"]:radio').change(function(){
      var radioval = $(this).val();
      if(radioval == 1){
        $('#place').removeAttr('disabled');
      } else {
        $('#place').attr('disabled','disabled');
      }
    });
  });

  $(function(){
    $('#event_confirm').on('click',function(){
      var title = $('#e_title').val();
      var body = $('#e_memo').val();
      var modal = $('#confi-modal');
      if ($('input:radio[name="event[date]"]:checked').val() == 1){
        const date = "";
        modal.find('#modalDate').text(date);
      } else {
        const date = $('input:radio[name="event[date]"]:checked').val();
        modal.find('#modalDate').text(date);
      }

      if ($('#place').val() == 1){
        const place = "";
        modal.find('#modalPlace').text(place);
      } else {
        const place = $('#place').val();
        modal.find('#modalPlace').text(place);
      }

      const createdDate = new Date($('#event_created_at_date').val());
      var year = createdDate.getFullYear().toString();
			var mm = (createdDate.getMonth() + 1).toString();
			var dd = createdDate.getDate().toString();
			var yyyymmdd = year + '年' + (mm[1]?mm:"0"+mm[0]) + '月' + (dd[1]?dd:"0"+dd[0]) + '日';
      const createdTime = $('#event_created_at_time').val();
      const people = $('#people').val();
      const genre = $('#event_genre_id').val();
      const genreText = $('#event_genre_id option:selected').text();
      const feel = $('#event_feel_id').val();
      const feelText = $('#event_feel_id option:selected').text();
      console.log(genreText);


      modal.find('#modalTitle').text(title);
      modal.find('#modalBody').text(body);
      modal.find('#modalFullDate').text(yyyymmdd);
      modal.find('#modalTime').text(createdTime);
      modal.find('#modalPeople').text(people);
      modal.find('#modalGenre').text(genreText);
      modal.find('#modalFeel').text(feelText);

    });
  });
  
  $("#btn_submit").click(function(){
    const email = $("#user_email").val();
    const password = $("#user_password").val();
    $.ajax({
      type: 'POST', //post,get
      url: "/sessions/create",
      data: {email: email, password: password},//user[name]
      dataType: "json",
      beforeSend: function(xhr) {
        xhr.setRequestHeader("X-CSRF-Token", $('meta[name="csrf-token"]').attr('content'))
      },
    }).done(function(data){
      console.log(data.error);
      if (data.message === "error"){
        console.log("komatta");
        $(".form-error").addClass('error-message');
      } else if (data.message === "success"){
        window.location.replace('<%= root_path %>');
      } 
    });
      // console.log($("#user_name").val());
  });



  $("#signup-btn").click(function(){
    const name = $("#user_new_name").val();
    const email = $("#user_new_email").val();
    const password = $("#user_new_password").val();
    const passconfi = $("#user_new_passconfi").val();
    $.ajax({
      type: 'POST', //post,get
      url: "/users/create",
      data: {name: name, email: email, password: password, password_confirmation: passconfi},//user[name]
      dataType: "json",
      beforeSend: function(xhr) {
        xhr.setRequestHeader("X-CSRF-Token", $('meta[name="csrf-token"]').attr('content'))
      },
    }).done(function(data){
      if (data.message === "success"){
        // console.log(data);
        sessionStorage.setItem('occupation','new_login');
        
        window.location.replace('<%= root_path %>');
       
        
      } else {
        console.log(data);
        alert(data.error);
      } 
      //alert(data.user.name + "で登録されました！")
    });
    // console.log($("#user_name").val());

  });
  window.addEventListener('load',()=>{
    if (sessionStorage.getItem('occupation') === 'new_login'){
      ModalApp();
      SignUpGaid();
      sessionStorage.removeItem('occupation')
    }
  });
</script>